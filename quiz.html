<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperfastSAT Diagnostic Test</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="container">
        <img src="superfastsat-logo.png" alt="SuperfastSAT Logo" class="logo" style="max-width:320px;display:block;margin:0 auto 16px auto;">
        <h1 style="text-align:center;">SAT Diagnostic Test</h1>
        <form action="/submit" method="POST" id="quizForm">
            <div class="student-info">
                <label for="studentName">Student Name</label>
                <input type="text" id="studentName" name="studentName" required>

                <label for="studentGrade" style="margin-top: 15px;">Grade</label>
                <select id="studentGrade" name="studentGrade" required>
                    <option value="">Select Grade</option>
                    <option value="US05">US05</option>
                    <option value="US06">US06</option>
                    <option value="US07">US07</option>
                    <option value="US08">US08</option>
                    <option value="US09">US09</option>
                    <option value="US10">US10</option>
                    <option value="US11">US11</option>
                    <option value="US12">US12</option>
                    <option value="Y07">Y07</option>
                    <option value="Y08">Y08</option>
                    <option value="Y09">Y09</option>
                    <option value="Y10">Y10</option>
                    <option value="Y11">Y11</option>
                    <option value="Y12">Y12</option>
                    <option value="Y13">Y13</option>
                    <option value="High School Graduate">High School Graduate</option>
                </select>

                <div class="notice-section" style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #071BE9;">
                    <h3 style="margin-top: 0; color: #071BE9; font-size: 1.1em;">Important Notice</h3>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        <li style="margin-bottom: 10px;">Please do not use GPT or any AI tools during this diagnostic test. Understanding what you need to study is much more valuable than getting a high score on this test.</li>
                        <li style="margin-bottom: 0;">Haven't studied for the SAT yet or worried about not improving your scores? Don't worry! SuperfastSAT is here to fully support your SAT success.</li>
                    </ul>
                </div>

            </div>

            <div id="questions-area"></div>
            <div class="timer-box" id="timerBox" style="display:none;"></div>
            <div class="submit-section" id="submitSection" style="display:block; text-align: center; margin-top: 30px;">
                <button type="submit" class="submit-btn" style="background: #071BE9; color: white; padding: 16px 32px; border: none; border-radius: 24px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                    Submit
                </button>
            </div>
        </form>
    </div>
    <script>
    let timerStarted = false;
    let timerInterval = null;
    function startTimer(duration) {
      let time = duration;
      const timerBox = document.getElementById('timerBox');
      timerBox.style.display = 'block';
      function updateTimer() {
        if (time < 0) {
          timerBox.textContent = '시간 종료';
          clearInterval(timerInterval);
          return;
        }
        const h = String(Math.floor(time / 3600)).padStart(2, '0');
        const m = String(Math.floor((time % 3600) / 60)).padStart(2, '0');
        const s = String(time % 60).padStart(2, '0');
        timerBox.textContent = `Time: ${h}:${m}:${s}`;
        time--;
      }
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }
    // 동적으로 문제를 생성하는 코드
    document.addEventListener('DOMContentLoaded', function() {
        Papa.parse('questions.csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data.filter(row => row.Question);
                const questionsArea = document.getElementById('questions-area');
                // Number(문제 번호) 기준으로 오름차순 정렬
                data.sort(function(a, b) {
                  const numA = parseInt(a.Number, 10);
                  const numB = parseInt(b.Number, 10);
                  if (isNaN(numA)) return 1;
                  if (isNaN(numB)) return -1;
                  return numA - numB;
                });

                // RW 아코디언 버튼 및 패널 생성
                const rwHeader = document.createElement('button');
                rwHeader.className = 'accordion-header';
                rwHeader.textContent = 'RW';
                rwHeader.type = 'button';
                const rwPanel = document.createElement('div');
                rwPanel.className = 'accordion-panel';
                rwPanel.style.display = 'none';
                // RW 아코디언 버튼에 펼침/접힘 기호 추가
                let rwOpen = false;
                const updateRwHeader = () => {
                  rwHeader.textContent = (rwOpen ? '▼ ' : '▶ ') + 'RW';
                };
                updateRwHeader();
                rwHeader.addEventListener('click', function() {
                  rwOpen = !rwOpen;
                  rwPanel.style.display = rwOpen ? 'block' : 'none';
                  updateRwHeader();
                  if (rwOpen && !timerStarted) {
                    timerStarted = true;
                    startTimer(3600);
                  }
                });

                // Math 아코디언 버튼 및 패널 생성
                const mathHeader = document.createElement('button');
                mathHeader.className = 'accordion-header';
                mathHeader.type = 'button';
                const mathPanel = document.createElement('div');
                mathPanel.className = 'accordion-panel';
                mathPanel.style.display = 'none';
                let mathOpen = false;
                const updateMathHeader = () => {
                  mathHeader.textContent = (mathOpen ? '▼ ' : '▶ ') + 'Math';
                };
                updateMathHeader();
                mathHeader.addEventListener('click', function() {
                  mathOpen = !mathOpen;
                  mathPanel.style.display = mathOpen ? 'block' : 'none';
                  updateMathHeader();
                  if (mathOpen && !timerStarted) {
                    timerStarted = true;
                    startTimer(3600);
                  }
                });

                data.forEach(function(row, idx) {
                    const qNum = row.Number || (idx + 1);
                    const qBlock = document.createElement('div');
                    qBlock.className = 'question-block';
                    
                    // 문제 타입 확인
                    const questionType = row.QuestionType || 'multiple_choice';
                    
                    // Passage
                    if(row.Passage && row.Passage.trim() !== '') {
                        const passageDiv = document.createElement('div');
                        passageDiv.className = 'passage';
                        passageDiv.innerHTML = row.Passage.replace(/\n/g, '<br>');
                        qBlock.appendChild(passageDiv);
                    }
                    // Question N
                    const qNumber = document.createElement('div');
                    qNumber.className = 'question-number';
                    qNumber.textContent = 'Question ' + qNum;
                    qBlock.appendChild(qNumber);
                    // Question Text
                    const qTitle = document.createElement('div');
                    qTitle.className = 'question-title';
                    qTitle.innerHTML = row.Question;
                    qBlock.appendChild(qTitle);
                    // Answer label
                    const answerLabel = document.createElement('div');
                    answerLabel.className = 'answer-label';
                    answerLabel.textContent = 'Answer';
                    qBlock.appendChild(answerLabel);
                    
                    // 문제 타입에 따라 다른 UI 생성
                    if (questionType === 'short_answer') {
                        // 주관식 문제 UI
                        const shortAnswerDiv = document.createElement('div');
                        shortAnswerDiv.className = 'short-answer-input';
                        shortAnswerDiv.style.marginBottom = '20px';
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.name = 'q' + row.Subject + qNum;
                        input.required = true;
                        input.placeholder = '답을 입력하세요';
                        input.style.width = '100%';
                        input.style.padding = '12px 16px';
                        input.style.border = '1.5px solid #e5e8f0';
                        input.style.borderRadius = '24px';
                        input.style.fontSize = '1.08em';
                        input.style.background = '#fafbfc';
                        input.style.boxSizing = 'border-box';
                        
                        shortAnswerDiv.appendChild(input);
                        qBlock.appendChild(shortAnswerDiv);
                    } else {
                        // 객관식 문제 UI
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'options';
                    ['A','B','C','D'].forEach(function(opt) {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'option-row';
                        rowDiv.style.display = 'flex';
                        rowDiv.style.alignItems = 'center';
                        rowDiv.style.marginBottom = '10px';
                        // 알파벳 라벨 (테두리 바깥)
                        const alphaLabel = document.createElement('span');
                        alphaLabel.textContent = opt;
                        alphaLabel.className = 'option-alpha-label';
                        rowDiv.appendChild(alphaLabel);
                        // 보기 라벨 (테두리 안)
                        const label = document.createElement('label');
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.style.width = '100%';
                        label.style.padding = '2px 16px'; // 위아래 2px, 좌우 16px
                        label.style.border = '1.5px solid #e5e8f0';
                        label.style.borderRadius = '24px';
                        label.style.background = '#fafbfc';
                        label.style.fontWeight = '500';
                        label.style.fontSize = '1.08em';
                        label.style.transition = 'border 0.2s, background 0.2s';
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = 'q' + row.Subject + qNum;
                        input.value = opt;
                        input.style.marginRight = '16px';
                        input.style.accentColor = '#071BE9';
                        if(opt==='A') input.required = true;
                        label.appendChild(input);
                        const span = document.createElement('span');
                        span.innerHTML = row['Option'+opt];
                        label.appendChild(span);
                        rowDiv.appendChild(label);
                        optionsDiv.appendChild(rowDiv);
                    });
                    qBlock.appendChild(optionsDiv);
                    }
                    // Confidence Rating (Answer 아래로 이동)
                    const confLabel = document.createElement('div');
                    confLabel.className = 'confidence-label';
                    confLabel.textContent = 'Confidence Rating';
                    qBlock.appendChild(confLabel);
                    const confBtns = document.createElement('div');
                    confBtns.className = 'confidence-buttons';
                    confBtns.style.display = 'flex';
                    confBtns.style.gap = '12px';
                    (row.ConfidenceOptions || '0,25,50,75,100').split(',').forEach(function(val, i) {
                        const label = document.createElement('label');
                        label.className = 'confidence-btn';
                        label.style.cursor = 'pointer';
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.style.justifyContent = 'center';
                        label.style.marginRight = '8px';
                        label.style.height = '40px';
                        label.style.minWidth = '64px';
                        label.style.border = '1.5px solid #e5e8f0';
                        label.style.borderRadius = '6px';
                        label.style.padding = '4px 12px';
                        label.style.background = '#fff';
                        label.style.transition = 'background 0.2s, color 0.2s, border 0.2s';
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = 'c' + row.Subject + qNum;
                        input.value = val;
                        input.style.marginRight = '6px';
                        input.style.accentColor = '#071BE9';
                        if(i===0) input.required = true;
                        label.appendChild(input);
                        const span = document.createElement('span');
                        span.textContent = val + '%';
                        span.style.display = 'inline-block';
                        span.style.width = '100%';
                        span.style.textAlign = 'center';
                        label.appendChild(span);
                        confBtns.appendChild(label);
                    });
                    qBlock.appendChild(confBtns);

                    // Subject 컬럼 기준으로 분류
                    if (row.Subject && row.Subject.trim() === 'Math') {
                      mathPanel.appendChild(qBlock);
                    } else {
                      rwPanel.appendChild(qBlock);
                    }

                    // MathJax 동적 렌더링 트리거
                    if (window.MathJax && window.MathJax.typesetPromise) {
                      window.MathJax.typesetPromise([qBlock]);
                    }
                });
                // RW, Math 아코디언 버튼/패널을 questionsArea에 추가
                questionsArea.insertBefore(rwHeader, questionsArea.firstChild);
                questionsArea.insertBefore(rwPanel, rwHeader.nextSibling);
                questionsArea.insertBefore(mathHeader, rwPanel.nextSibling);
                questionsArea.insertBefore(mathPanel, mathHeader.nextSibling);
            }
        });


    });

    // 폼 제출 시 누락된 부분으로 자동 스크롤하는 기능
    document.getElementById('quizForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 문제별로 답안(q...)과 확신도(c...) 그룹을 모두 체크했는지 확인
        const form = this;
        const allInputs = Array.from(form.querySelectorAll('input[type="radio"], input[type="text"]'));
        const questionNames = new Set();
        const confidenceNames = new Set();
        allInputs.forEach(input => {
            if (input.name.startsWith('q')) questionNames.add(input.name);
            if (input.name.startsWith('c')) confidenceNames.add(input.name);
        });
        const missingFields = [];
        // 답안 체크
        questionNames.forEach(name => {
            const group = form.querySelectorAll(`input[name='${name}']`);
            const isChecked = Array.from(group).some(input => input.checked || (input.type === 'text' && input.value.trim() !== ''));
            if (!isChecked) missingFields.push(group[0]);
        });
        // 확신도 체크
        confidenceNames.forEach(name => {
            const group = form.querySelectorAll(`input[name='${name}']`);
            const isChecked = Array.from(group).some(input => input.checked);
            if (!isChecked) missingFields.push(group[0]);
        });
        if (missingFields.length > 0) {
            // 누락된 필드들을 위치 순으로 정렬 (상단부터)
            missingFields.sort((a, b) => {
                const rectA = a.getBoundingClientRect();
                const rectB = b.getBoundingClientRect();
                return rectA.top - rectB.top;
            });
            // 첫 번째 누락된 필드로 스크롤
            const firstMissingField = missingFields[0];
            firstMissingField.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            // 시각적 강조 효과 추가
            firstMissingField.style.border = '2px solid #e74c3c';
            firstMissingField.style.boxShadow = '0 0 10px rgba(231, 76, 60, 0.3)';
            // 3초 후 강조 효과 제거
            setTimeout(() => {
                firstMissingField.style.border = '';
                firstMissingField.style.boxShadow = '';
            }, 3000);
            // 알림 메시지 표시
            showNotification(`Please complete ${missingFields.length} missing field(s). Scrolling to the first one...`);
            return false;
        }
        // 모든 필수 필드가 완료되면 폼 제출
        this.submit();
    });
    
    // 알림 메시지 함수
    function showNotification(message) {
        // 기존 알림 제거
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // 새 알림 생성
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideDown 0.3s ease-out;
        `;
        
        document.body.appendChild(notification);
        
        // 4초 후 알림 제거
        setTimeout(() => {
            notification.style.animation = 'slideUp 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
    </script>
    <style>
    .accordion-header {
      width: 100%;
      text-align: left;
      padding: 14px;
      font-size: 1.1em;
      background: #fff;
      border: 2px solid #071BE9;
      border-radius: 24px;
      margin-bottom: 12px;
      cursor: pointer;
      outline: none;
      transition: background 0.2s, border 0.2s;
    }
    .accordion-header:hover {
      background: #f3f4f6;
    }
    .accordion-panel {
      padding: 0 14px 14px 14px;
      border-bottom: 1px solid #e5e8f0;
      background: #fff;
    }
    .option-row {
      display: flex;
      align-items: center;
    }
    .option-alpha-label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      min-width: 32px;
      height: 32px;
      font-weight: 700;
      font-size: 1.08em;
      color: #071BE9;
      background: #fff;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      margin-right: 12px;
      user-select: none;
      box-sizing: border-box;
      transition: border 0.2s, background 0.2s;
    }
    .timer-box {
      position: fixed;
      top: 32px;
      right: 280px;
      z-index: 1000;
      background: #071BE9;
      color: #fff;
      font-size: 1.35em;
      font-weight: 700;
      padding: 14px 32px;
      border-radius: 32px;
      box-shadow: 0 4px 16px rgba(7,27,233,0.08);
      letter-spacing: 1px;
      transition: background 0.2s;
      opacity: 0.97;
      user-select: none;
    }
    .submit-btn:hover {
      background: #0515c7 !important;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
    }
    </style>
</body>
</html>