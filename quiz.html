<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperfastSAT Diagnostic Test</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        // MathJax CDN ë¡œë“œ ìƒíƒœ í™•ì¸
        window.addEventListener('load', function() {
            console.log('ğŸ” í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            
            // MathJax ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¼
            const mathJaxScript = document.getElementById('MathJax-script');
            if (mathJaxScript) {
                mathJaxScript.addEventListener('load', function() {
                    console.log('âœ… MathJax ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
                    // MathJaxê°€ ì¤€ë¹„ë˜ë©´ ì¦‰ì‹œ ë Œë”ë§
                    setTimeout(() => {
                        if (window.MathJax && window.pendingMathJaxRenders) {
                            console.log('ğŸ” MathJax ì¤€ë¹„ë¨, ì˜ˆì•½ëœ ë Œë”ë§ ì‹¤í–‰');
                            executeAllPendingRenders();
                        }
                    }, 500);
                });
            }
        });
        // MathJax ì„¤ì • ì™„ì „ ìƒˆë¡œ ì‘ì„± (TikZ + pgfplots ì§€ì›)
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: ['base', 'ams', 'noerrors', 'noundefined', 'tikz', 'pgfplots'],
                macros: {
                    // TikZ ê´€ë ¨ ë§¤í¬ë¡œ ì •ì˜
                    'tikz': '\\text{tikz}',
                    'pgfplots': '\\text{pgfplots}',
                    'draw': '\\text{draw}',
                    'plot': '\\text{plot}',
                    'axis': '\\text{axis}',
                    'addplot': '\\text{addplot}'
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            },
            startup: {
                pageReady: () => {
                    console.log('âœ… MathJax ì¦‰ì‹œ ë Œë”ë§ ì‹œì‘ (TikZ ì§€ì›)');
                    // ëª¨ë“  ì˜ˆì•½ëœ ë Œë”ë§ ì¦‰ì‹œ ì‹¤í–‰
                    if (window.pendingMathJaxRenders && window.pendingMathJaxRenders.length > 0) {
                        executeAllPendingRenders();
                    }
                }
            }
        };
        
        // ê°„ë‹¨í•œ MathJax ì¤€ë¹„ í™•ì¸ í•¨ìˆ˜
        function checkMathJaxReady() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                console.log('âœ… MathJax ì¤€ë¹„ë¨');
                return true;
            }
            return false;
        }
        
        // TikZ ì½”ë“œë¥¼ LaTeXë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
        function convertTikZToLatex(tikzCode) {
            if (!tikzCode || !tikzCode.includes('tikzpicture')) {
                return tikzCode;
            }
            
            console.log('ğŸ” TikZ ì½”ë“œ ë³€í™˜ ì‹œì‘:', tikzCode.substring(0, 100));
            
            // TikZ í™˜ê²½ì„ LaTeXë¡œ ë³€í™˜
            let latexCode = tikzCode
                .replace(/\\begin\{tikzpicture\}/g, '\\begin{center}\\begin{tikzpicture}')
                .replace(/\\end\{tikzpicture\}/g, '\\end{tikzpicture}\\end{center}')
                .replace(/\\begin\{axis\}/g, '\\begin{center}\\begin{axis}')
                .replace(/\\end\{axis\}/g, '\\end{axis}\\end{center}');
            
            console.log('âœ… TikZ ë³€í™˜ ì™„ë£Œ:', latexCode.substring(0, 100));
            return latexCode;
        }
        
        // MathJaxê°€ ì¤€ë¹„ë˜ë©´ ìë™ìœ¼ë¡œ ë Œë”ë§í•˜ë„ë¡ ì˜ˆì•½í•˜ëŠ” í•¨ìˆ˜
        function scheduleMathJaxRendering(qBlock, row) {
            // ì˜ˆì•½ëœ ë Œë”ë§ì„ ì „ì—­ ë°°ì—´ì— ì €ì¥
            if (!window.pendingMathJaxRenders) {
                window.pendingMathJaxRenders = [];
            }
            
            window.pendingMathJaxRenders.push({ qBlock, row });
            console.log('ğŸ“ MathJax ë Œë”ë§ ì˜ˆì•½ë¨:', row.Number, row.Subject);
        }
        
        // ì˜ˆì•½ëœ ëª¨ë“  ë Œë”ë§ì„ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜
        function executeAllPendingRenders() {
            if (!window.pendingMathJaxRenders || window.pendingMathJaxRenders.length === 0) {
                console.log('ğŸ” ì˜ˆì•½ëœ ë Œë”ë§ì´ ì—†ìŒ');
                return;
            }
            
            console.log(`ğŸ” ${window.pendingMathJaxRenders.length}ê°œì˜ ì˜ˆì•½ëœ ë Œë”ë§ ì‹¤í–‰ ì‹œì‘`);
            
            window.pendingMathJaxRenders.forEach(({ qBlock, row }) => {
                console.log('ğŸ” ì˜ˆì•½ëœ ë Œë”ë§ ì‹¤í–‰:', row.Number, row.Subject);
                
                // LaTeX êµ¬ë¬¸ ë³µì› ë° ë Œë”ë§
                const mathElements = qBlock.querySelectorAll('p');
                mathElements.forEach(p => {
                    let html = p.innerHTML;
                    html = html.replace(/&#92;&#91;/g, '\\[');
                    html = html.replace(/&#92;&#93;/g, '\\]');
                    html = html.replace(/&#92;&#40;/g, '\\(');
                    html = html.replace(/&#92;&#41;/g, '\\)');
                    html = html.replace(/&#92;cdot/g, '\\cdot');
                    html = html.replace(/&#92;tfrac/g, '\\tfrac');
                    html = html.replace(/&#92;frac/g, '\\frac');
                    html = html.replace(/&#92;sqrt/g, '\\sqrt');
                    html = html.replace(/&#92;sum/g, '\\sum');
                    html = html.replace(/&#92;int/g, '\\int');
                    
                    if (html !== p.innerHTML) {
                        console.log('ğŸ” ì˜ˆì•½ëœ LaTeX êµ¬ë¬¸ ë³µì›:', html.substring(0, 100));
                        p.innerHTML = html;
                    }
                });
                
                window.MathJax.typesetPromise([qBlock]).then(() => {
                    console.log('âœ… ì˜ˆì•½ëœ MathJax ë Œë”ë§ ì™„ë£Œ:', row.Number, row.Subject);
                }).catch(error => {
                    console.error('âŒ ì˜ˆì•½ëœ MathJax ë Œë”ë§ ì˜¤ë¥˜:', error);
                });
            });
            
            // ì˜ˆì•½ëœ ë Œë”ë§ ëª©ë¡ ì´ˆê¸°í™”
            window.pendingMathJaxRenders = [];
        }
    </script>
</head>
<body>
    <div class="container">
        <img src="superfastsat-logo.png" alt="SuperfastSAT Logo" class="logo" style="max-width:320px;display:block;margin:0 auto 16px auto;">
        <h1 style="text-align:center;">SAT Diagnostic Test</h1>
        <form action="/submit" method="POST" id="quizForm">
            <div class="student-info">
                <label for="studentName">Student Name</label>
                <input type="text" id="studentName" name="studentName" required>

                <label for="studentGrade" style="margin-top: 15px;">Grade</label>
                <select id="studentGrade" name="studentGrade" required>
                    <option value="">Select Grade</option>
                    <option value="US05">US05</option>
                    <option value="US06">US06</option>
                    <option value="US07">US07</option>
                    <option value="US08">US08</option>
                    <option value="US09">US09</option>
                    <option value="US10">US10</option>
                    <option value="US11">US11</option>
                    <option value="US12">US12</option>
                    <option value="Y07">Y07</option>
                    <option value="Y08">Y08</option>
                    <option value="Y09">Y09</option>
                    <option value="Y10">Y10</option>
                    <option value="Y11">Y11</option>
                    <option value="Y12">Y12</option>
                    <option value="Y13">Y13</option>
                    <option value="High School Graduate">High School Graduate</option>
                </select>

                <div class="notice-section" style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px; border-left: 4px solid #071BE9;">
                    <h3 style="margin-top: 0; color: #071BE9; font-size: 1.1em;">Important Notice</h3>
                    <p style="margin: 0 0 5px 0; color: #555; font-weight: 700; text-decoration: underline;">You must select both Confidence Rating and Answer to submit properly. Please check all items to quickly receive your diagnostic results. We receive many inquiries from students who cannot click the submit button because they did not select all required items.</p>
                    <ul style="margin: 0; padding-left: 20px; color: #555;">
                        <li style="margin-bottom: 10px;">Please do not use GPT or any AI tools during this diagnostic test. Understanding what you need to study is much more valuable than getting a high score on this test.</li>
                        <li style="margin-bottom: 0;">Havent studied for the SAT yet or worried about not improving your scores? Don't worry! SuperfastSAT is here to fully support your SAT success.</li>
                    </ul>
                </div>

            </div>

            <div id="questions-area"></div>
            <div class="submit-section" id="submitSection" style="display:block; text-align: center; margin-top: 30px;">
                <button type="submit" class="submit-btn" style="background: #071BE9; color: white; padding: 16px 32px; border: none; border-radius: 24px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background 0.2s;">
                    Submit
                </button>
            </div>
        </form>
    </div>
    <script>
    let timerStarted = false;
    let timerInterval = null;
    
    // HTML ì—”í‹°í‹°ë¥¼ ë””ì½”ë”©í•˜ëŠ” í•¨ìˆ˜
    function decodeHtmlEntities(text) {
        if (typeof text !== 'string') return text;
        
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }
    
    // í…ìŠ¤íŠ¸ë¥¼ ì•ˆì „í•˜ê²Œ HTMLë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
    function renderTextSafely(text) {
        if (!text) return '';
        
        // HTML ì—”í‹°í‹° ë””ì½”ë”©
        let decodedText = decodeHtmlEntities(text);
        
        // ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
        decodedText = decodedText.replace(/\n/g, '<br>');
        
        // ì¶”ê°€ì ì¸ íŠ¹ìˆ˜ ë¬¸ì ì²˜ë¦¬
        // ì˜¨ë„ ê¸°í˜¸ê°€ ì œëŒ€ë¡œ í‘œì‹œë˜ë„ë¡ ë³´ì¥
        decodedText = decodedText.replace(/&deg;/g, 'Â°');
        
        // ì½¤ë§ˆê°€ ì œëŒ€ë¡œ í‘œì‹œë˜ë„ë¡ ë³´ì¥ (ìˆ«ì ì‚¬ì´ì˜ ê³µë°± ì œê±°)
        decodedText = decodedText.replace(/(\d)\s+(\d{3})/g, '$1,$2');
        
        // LaTeX êµ¬ë¬¸ì„ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜í•˜ì—¬ MathJaxê°€ ì¸ì‹í•˜ë„ë¡ í•¨
        decodedText = decodedText.replace(/\\\[/g, '&#92;&#91;');
        decodedText = decodedText.replace(/\\\]/g, '&#92;&#93;');
        decodedText = decodedText.replace(/\\\(/g, '&#92;&#40;');
        decodedText = decodedText.replace(/\\\)/g, '&#92;&#41;');
        
        // ì¶”ê°€ LaTeX ëª…ë ¹ì–´ë“¤ë„ HTML ì—”í‹°í‹°ë¡œ ë³€í™˜
        decodedText = decodedText.replace(/\\cdot/g, '&#92;cdot');
        decodedText = decodedText.replace(/\\tfrac/g, '&#92;tfrac');
        decodedText = decodedText.replace(/\\frac/g, '&#92;frac');
        decodedText = decodedText.replace(/\\sqrt/g, '&#92;sqrt');
        decodedText = decodedText.replace(/\\sum/g, '&#92;sum');
        decodedText = decodedText.replace(/\\int/g, '&#92;int');
        
        // ë¬¸ì¥ ë‚´ ì½¤ë§ˆê°€ ì œëŒ€ë¡œ í‘œì‹œë˜ë„ë¡ ë³´ì¥
        // "word1  word2" í˜•íƒœë¥¼ "word1, word2"ë¡œ ë³€í™˜
        decodedText = decodedText.replace(/([a-zA-Z])\s{2,}([a-zA-Z])/g, '$1, $2');
        
        // ìˆ˜í•™ ìˆ˜ì‹ì—ì„œ íŠ¹ìˆ˜ ë¬¸ìê°€ ì œëŒ€ë¡œ í‘œì‹œë˜ë„ë¡ ë³´ì¥
        // LaTeX ìˆ˜ì‹ ë‚´ì˜ íŠ¹ìˆ˜ ë¬¸ì ì²˜ë¦¬
        decodedText = decodedText.replace(/\\([a-zA-Z]+)/g, '\\\\$1');
        
        return decodedText;
    }
    
    // íƒ€ì´ë¨¸ ìœ„ì¹˜ë¥¼ ì•„ì½”ë””ì–¸ ê¸°ì¤€ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateTimerPosition() {
      const activePanel = document.querySelector('.accordion-panel[style*="display: block"]');
      if (activePanel) {
        const panelRect = activePanel.getBoundingClientRect();
        const containerRect = document.querySelector('.container').getBoundingClientRect();
        
        // ë·°í¬íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ì ˆëŒ€ ìœ„ì¹˜ ê³„ì‚°
        const viewportLeft = panelRect.right + 20; // ì•„ì½”ë””ì–¸ ì˜¤ë¥¸ìª½ì—ì„œ 20px ë–¨ì–´ì§„ ìœ„ì¹˜
        
        const timerBox = document.getElementById('timerBox');
        if (timerBox) {
          timerBox.style.left = viewportLeft + 'px';
          timerBox.style.right = 'auto';
        }
      }
    }

    function startTimer(duration) {
      let time = duration;
      const timerBox = document.getElementById('timerBox');
      timerBox.style.display = 'block';
      
      // íƒ€ì´ë¨¸ë¥¼ ì•„ì½”ë””ì–¸ ì˜¤ë¥¸ìª½ì— í‘œì‹œ
      updateTimerPosition();
      console.log('â° íƒ€ì´ë¨¸ ì‹œì‘ - ì•„ì½”ë””ì–¸ ì˜¤ë¥¸ìª½');
      
      // ìŠ¤í¬ë¡¤ ì‹œ íƒ€ì´ë¨¸ ìœ„ì¹˜ ìœ ì§€
      window.addEventListener('scroll', updateTimerPosition);
      
      // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ íƒ€ì´ë¨¸ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
      window.addEventListener('resize', updateTimerPosition);
      
      // íƒ€ì´ë¨¸ ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
      makeDraggable(timerBox);
      
      function updateTimer() {
        if (time < 0) {
          timerBox.textContent = 'ì‹œê°„ ì¢…ë£Œ';
          clearInterval(timerInterval);
          
          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
          window.removeEventListener('scroll', updateTimerPosition);
          window.removeEventListener('resize', updateTimerPosition);
          return;
        }
        const h = String(Math.floor(time / 3600)).padStart(2, '0');
        const m = String(Math.floor((time % 3600) / 60)).padStart(2, '0');
        const s = String(time % 60).padStart(2, '0');
        timerBox.textContent = `Time: ${h}:${m}:${s}`;
        time--;
      }
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }
    // ë™ì ìœ¼ë¡œ ë¬¸ì œë¥¼ ìƒì„±í•˜ëŠ” ì½”ë“œ
    document.addEventListener('DOMContentLoaded', function() {
        Papa.parse('questions.csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                console.log('ğŸ” CSV íŒŒì‹± ê²°ê³¼:', results);
                console.log('ğŸ“Š ì „ì²´ ë°ì´í„° ê°œìˆ˜:', results.data.length);
                
                const data = results.data.filter(row => row.Question || row.Subject === 'Math');
                console.log('âœ… Questionì´ ìˆëŠ” ë°ì´í„° ê°œìˆ˜:', data.length);
                
                // Math ë¬¸ì œë§Œ ë”°ë¡œ í™•ì¸
                const mathProblems = data.filter(row => row.Subject === 'Math');
                console.log('ğŸ¯ Math ë¬¸ì œ ê°œìˆ˜:', mathProblems.length);
                mathProblems.forEach((row, idx) => {
                    console.log(`Math ${idx + 1}:`, row.Number, row.Subject, row.QuestionType, 'Question:', row.Question ? 'ìˆìŒ' : 'ì—†ìŒ');
                });
                
                // í•„í„°ë§ëœ ëª¨ë“  ë°ì´í„° í™•ì¸
                console.log('ğŸ” í•„í„°ë§ëœ ëª¨ë“  ë°ì´í„°:');
                data.forEach((row, idx) => {
                    console.log(`${idx + 1}:`, row.Number, row.Subject, row.QuestionType, 'Question:', row.Question ? 'ìˆìŒ' : 'ì—†ìŒ');
                });
                const questionsArea = document.getElementById('questions-area');
                // Number(ë¬¸ì œ ë²ˆí˜¸) ê¸°ì¤€ìœ¼ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
                data.sort(function(a, b) {
                  const numA = parseInt(a.Number, 10);
                  const numB = parseInt(b.Number, 10);
                  if (isNaN(numA)) return 1;
                  if (isNaN(numB)) return -1;
                  return numA - numB;
                });

                // RW ì•„ì½”ë””ì–¸ ë²„íŠ¼ ë° íŒ¨ë„ ìƒì„±
                const rwHeader = document.createElement('button');
                rwHeader.className = 'accordion-header';
                rwHeader.textContent = 'RW';
                rwHeader.type = 'button';
                const rwPanel = document.createElement('div');
                rwPanel.className = 'accordion-panel';
                rwPanel.style.display = 'none';
                rwPanel.style.position = 'relative';
                
                // íƒ€ì´ë¨¸ë¥¼ bodyì— ì§ì ‘ ì¶”ê°€ (ë¬¸ì œ ì˜ì—­ ì˜†ì— ë³´ì´ë„ë¡)
                const timerBox = document.createElement('div');
                timerBox.className = 'timer-box';
                timerBox.id = 'timerBox';
                timerBox.style.display = 'none';
                timerBox.style.position = 'fixed';
                timerBox.style.top = '100px';
                timerBox.style.left = 'auto';
                timerBox.style.right = '20px';
                timerBox.style.zIndex = '1000';
                timerBox.style.background = 'rgba(7, 27, 233, 0.9)';
                timerBox.style.color = 'white';
                timerBox.style.padding = '20px 30px';
                timerBox.style.borderRadius = '12px';
                timerBox.style.fontSize = '24px';
                timerBox.style.fontWeight = 'bold';
                timerBox.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.2)';
                timerBox.style.border = '3px solid rgba(255, 255, 255, 0.3)';
                timerBox.style.minWidth = '200px';
                timerBox.style.textAlign = 'center';
                document.body.appendChild(timerBox);
                // RW ì•„ì½”ë””ì–¸ ë²„íŠ¼ì— í¼ì¹¨/ì ‘í˜ ê¸°í˜¸ ì¶”ê°€
                let rwOpen = false;
                const updateRwHeader = () => {
                  rwHeader.textContent = (rwOpen ? 'â–¼ ' : 'â–¶ ') + 'RW';
                };
                updateRwHeader();
                rwHeader.addEventListener('click', function() {
                  rwOpen = !rwOpen;
                  rwPanel.style.display = rwOpen ? 'block' : 'none';
                  updateRwHeader();
                  
                  // RW ì•„ì½”ë””ì–¸ ìƒíƒœì— ë”°ë¼ required ì†ì„± ê´€ë¦¬
                  const rwInputs = rwPanel.querySelectorAll('input[required]');
                  rwInputs.forEach(input => {
                    if (rwOpen) {
                      input.required = true;
                    } else {
                      input.required = false;
                    }
                  });
                  
                  if (rwOpen) {
                    startTimerIfFirst('RW');
                    // íƒ€ì´ë¨¸ ìœ„ì¹˜ë¥¼ RW íŒ¨ë„ ê¸°ì¤€ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    updateTimerPosition();
                  }
                });

                // Math ì•„ì½”ë””ì–¸ ë²„íŠ¼ ë° íŒ¨ë„ ìƒì„±
                const mathHeader = document.createElement('button');
                mathHeader.className = 'accordion-header';
                mathHeader.type = 'button';
                const mathPanel = document.createElement('div');
                mathPanel.className = 'accordion-panel';
                mathPanel.style.display = 'none';
                // Math ì•„ì½”ë””ì–¸ ë²„íŠ¼ì— í¼ì¹¨/ì ‘í˜ ê¸°í˜¸ ì¶”ê°€
                let mathOpen = false;
                const updateMathHeader = () => {
                  mathHeader.textContent = (mathOpen ? 'â–¼ ' : 'â–¶ ') + 'Math';
                };
                updateMathHeader();
                mathHeader.addEventListener('click', function() {
                  mathOpen = !mathOpen;
                  mathPanel.style.display = mathOpen ? 'block' : 'none';
                  updateMathHeader();
                  
                  // Math ì•„ì½”ë””ì–¸ ìƒíƒœì— ë”°ë¼ required ì†ì„± ê´€ë¦¬
                  const mathInputs = mathPanel.querySelectorAll('input[required]');
                  mathInputs.forEach(input => {
                    if (mathOpen) {
                      input.required = true;
                    } else {
                      input.required = false;
                    }
                  });
                  
                  if (mathOpen) {
                    startTimerIfFirst('Math');
                    // íƒ€ì´ë¨¸ ìœ„ì¹˜ë¥¼ Math íŒ¨ë„ ê¸°ì¤€ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    updateTimerPosition();
                  }
                });

                data.forEach(function(row, idx) {
                    const qNum = row.Number || (idx + 1);
                    const qBlock = document.createElement('div');
                    qBlock.className = 'question-block';
                    
                    // ë””ë²„ê¹…: ëª¨ë“  ë¬¸ì œ ì •ë³´ í™•ì¸
                    console.log('ë¬¸ì œ ë¡œë“œ:', row.Number, 'Subject:', row.Subject, 'Type:', row.QuestionType);
                    
                    // Math ë¬¸ì œ íŠ¹ë³„ í™•ì¸
                    if (row.Subject === 'Math') {
                        console.log('ğŸ¯ Math ë¬¸ì œ ë°œê²¬:', row.Number, row.Subject, row.Question);
                    }
                    
                    // ë¬¸ì œ íƒ€ì… í™•ì¸
                    const questionType = row.QuestionType || 'multiple_choice';
                    
                    // Passage
                    if(row.Passage && row.Passage.trim() !== '') {
                        const passageDiv = document.createElement('div');
                        passageDiv.className = 'passage';
                        passageDiv.innerHTML = renderTextSafely(row.Passage);
                        qBlock.appendChild(passageDiv);
                    }
                    // Question N
                    const qNumber = document.createElement('div');
                    qNumber.className = 'question-number';
                    qNumber.textContent = 'Question ' + qNum;
                    qBlock.appendChild(qNumber);
                    // Question Text
                    const qTitle = document.createElement('div');
                    qTitle.className = 'question-title';
                    qTitle.innerHTML = renderTextSafely(row.Question);
                    qBlock.appendChild(qTitle);
                    // Answer label
                    const answerLabel = document.createElement('div');
                    answerLabel.className = 'answer-label';
                    answerLabel.textContent = 'Answer';
                    qBlock.appendChild(answerLabel);
                    
                    // ë¬¸ì œ íƒ€ì…ì— ë”°ë¼ ë‹¤ë¥¸ UI ìƒì„±
                    if (questionType === 'short_answer') {
                        // ì£¼ê´€ì‹ ë¬¸ì œ UI
                        const shortAnswerDiv = document.createElement('div');
                        shortAnswerDiv.className = 'short-answer-input';
                        shortAnswerDiv.style.marginBottom = '20px';
                        
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.name = 'q' + row.Subject + qNum;
                        input.required = true;
                        input.placeholder = 'ë‹µì„ ì…ë ¥í•˜ì„¸ìš”';
                        input.style.width = '100%';
                        input.style.padding = '12px 16px';
                        input.style.border = '1.5px solid #e5e8f0';
                        input.style.borderRadius = '24px';
                        input.style.fontSize = '1.08em';
                        input.style.background = '#fafbfc';
                        input.style.boxSizing = 'border-box';
                        
                        shortAnswerDiv.appendChild(input);
                        qBlock.appendChild(shortAnswerDiv);
                    } else {
                        // ê°ê´€ì‹ ë¬¸ì œ UI
                    const optionsDiv = document.createElement('div');
                    optionsDiv.className = 'options';
                    ['A','B','C','D'].forEach(function(opt) {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'option-row';
                        rowDiv.style.display = 'flex';
                        rowDiv.style.alignItems = 'center';
                        rowDiv.style.marginBottom = '10px';
                        // ì•ŒíŒŒë²³ ë¼ë²¨ (í…Œë‘ë¦¬ ë°”ê¹¥)
                        const alphaLabel = document.createElement('span');
                        alphaLabel.textContent = opt;
                        alphaLabel.className = 'option-alpha-label';
                        rowDiv.appendChild(alphaLabel);
                        // ë³´ê¸° ë¼ë²¨ (í…Œë‘ë¦¬ ì•ˆ)
                        const label = document.createElement('label');
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.style.width = '100%';
                        label.style.padding = '2px 16px'; // ìœ„ì•„ë˜ 2px, ì¢Œìš° 16px
                        label.style.border = '1.5px solid #e5e8f0';
                        label.style.borderRadius = '24px';
                        label.style.background = '#fafbfc';
                        label.style.fontWeight = '500';
                        label.style.fontSize = '1.08em';
                        label.style.transition = 'border 0.2s, background 0.2s';
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = 'q' + row.Subject + qNum;
                        input.value = opt;
                        input.style.marginRight = '16px';
                        input.style.accentColor = '#071BE9';
                        if(opt==='A') input.required = true;
                        label.appendChild(input);
                        const span = document.createElement('span');
                        span.innerHTML = renderTextSafely(row['Option'+opt]);
                        label.appendChild(span);
                        rowDiv.appendChild(label);
                        optionsDiv.appendChild(rowDiv);
                    });
                    qBlock.appendChild(optionsDiv);
                    }
                    // Confidence Rating (Answer ì•„ë˜ë¡œ ì´ë™)
                    const confLabel = document.createElement('div');
                    confLabel.className = 'confidence-label';
                    confLabel.textContent = 'Confidence Rating';
                    qBlock.appendChild(confLabel);
                    const confBtns = document.createElement('div');
                    confBtns.className = 'confidence-buttons';
                    confBtns.style.display = 'flex';
                    confBtns.style.gap = '12px';
                    (row.ConfidenceOptions || '0,25,50,75,100').split(',').forEach(function(val, i) {
                        const label = document.createElement('label');
                        label.className = 'confidence-btn';
                        label.style.cursor = 'pointer';
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.style.justifyContent = 'center';
                        label.style.marginRight = '8px';
                        label.style.height = '40px';
                        label.style.minWidth = '64px';
                        label.style.border = '1.5px solid #e5e8f0';
                        label.style.borderRadius = '6px';
                        label.style.padding = '4px 12px';
                        label.style.background = '#fff';
                        label.style.transition = 'background 0.2s, color 0.2s, border 0.2s';
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = 'c' + row.Subject + qNum;
                        input.value = val;
                        input.style.marginRight = '6px';
                        input.style.accentColor = '#071BE9';
                        if(i===0) input.required = true;
                        label.appendChild(input);
                        const span = document.createElement('span');
                        span.textContent = val + '%';
                        span.style.display = 'inline-block';
                        span.style.width = '100%';
                        span.style.textAlign = 'center';
                        label.appendChild(span);
                        confBtns.appendChild(label);
                    });
                    qBlock.appendChild(confBtns);

                    // Subject ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¥˜
                    console.log('ğŸ” ë¬¸ì œ ë¶„ë¥˜:', row.Number, 'Subject:', row.Subject, 'Type:', typeof row.Subject, 'Length:', row.Subject ? row.Subject.length : 0);
                    
                    if (row.Subject && row.Subject.trim() === 'Math') {
                      console.log('âœ… Math íŒ¨ë„ì— ì¶”ê°€:', row.Number);
                      mathPanel.appendChild(qBlock);
                    } else {
                      console.log('ğŸ“š RW íŒ¨ë„ì— ì¶”ê°€:', row.Number);
                      rwPanel.appendChild(qBlock);
                    }

                    // MathJax ë™ì  ë Œë”ë§ íŠ¸ë¦¬ê±° (íŠ¹ìˆ˜ ë¬¸ì ì²˜ë¦¬ í›„)
                    if (checkMathJaxReady()) {
                      // MathJaxê°€ ì¤€ë¹„ëœ ê²½ìš° ì¦‰ì‹œ ë Œë”ë§
                      setTimeout(() => {
                        try {
                          console.log('ğŸ” MathJax ë Œë”ë§ ì‹œì‘:', row.Number, row.Subject);
                          
                                              // LaTeX êµ¬ë¬¸ì„ ê°•ì œë¡œ ë³µì›í•˜ì—¬ MathJaxê°€ ì¸ì‹í•˜ë„ë¡ í•¨
                    const mathElements = qBlock.querySelectorAll('p');
                    mathElements.forEach(p => {
                        let html = p.innerHTML;
                        // HTML ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ LaTeX êµ¬ë¬¸ìœ¼ë¡œ ë³µì›
                        html = html.replace(/&#92;&#91;/g, '\\[');
                        html = html.replace(/&#92;&#93;/g, '\\]');
                        html = html.replace(/&#92;&#40;/g, '\\(');
                        html = html.replace(/&#92;&#41;/g, '\\)');
                        html = html.replace(/&#92;cdot/g, '\\cdot');
                        html = html.replace(/&#92;tfrac/g, '\\tfrac');
                        html = html.replace(/&#92;frac/g, '\\frac');
                        html = html.replace(/&#92;sqrt/g, '\\sqrt');
                        html = html.replace(/&#92;sum/g, '\\sum');
                        html = html.replace(/&#92;int/g, '\\int');
                        
                        // TikZ ì½”ë“œ ë³€í™˜ ì ìš©
                        html = convertTikZToLatex(html);
                        
                        if (html !== p.innerHTML) {
                            console.log('ğŸ” LaTeX êµ¬ë¬¸ ë³µì› + TikZ ë³€í™˜:', html.substring(0, 100));
                            p.innerHTML = html;
                        }
                    });
                          
                          window.MathJax.typesetPromise([qBlock]).then(() => {
                            console.log('âœ… MathJax ë Œë”ë§ ì™„ë£Œ:', row.Number, row.Subject);
                          }).catch(error => {
                            console.error('âŒ MathJax ë Œë”ë§ ì˜¤ë¥˜:', error);
                          });
                        } catch (error) {
                          console.error('âŒ MathJax typesetPromise ì˜¤ë¥˜:', error);
                        }
                      }, 100);
                    } else {
                      // MathJaxê°€ ì¤€ë¹„ë˜ì§€ ì•Šì€ ê²½ìš° ì˜ˆì•½
                      scheduleMathJaxRendering(qBlock, row);
                    }
                });
                // í†µí•© íƒ€ì´ë¨¸ ì‹œì‘ í•¨ìˆ˜
                function startTimerIfFirst(accordionType) {
                  if (!timerStarted) {
                    timerStarted = true;
                    console.log(`â° ${accordionType} ì•„ì½”ë””ì–¸ì—ì„œ íƒ€ì´ë¨¸ ì‹œì‘ (30ë¶„)`);
                    startTimer(1800); // 30ë¶„ (1800ì´ˆ)
                  } else {
                    console.log(`â° íƒ€ì´ë¨¸ê°€ ì´ë¯¸ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤ (${accordionType} ì•„ì½”ë””ì–¸)`);
                  }
                }
                
                // RW, Math ì•„ì½”ë””ì–¸ ë²„íŠ¼/íŒ¨ë„ì„ questionsAreaì— ì¶”ê°€
                questionsArea.insertBefore(rwHeader, questionsArea.firstChild);
                questionsArea.insertBefore(rwPanel, rwHeader.nextSibling);
                questionsArea.insertBefore(mathHeader, rwPanel.nextSibling);
                questionsArea.insertBefore(mathPanel, mathHeader.nextSibling);
                
                // Math íŒ¨ë„ ìƒíƒœ í™•ì¸
                console.log('ğŸ” Math íŒ¨ë„ ìƒíƒœ í™•ì¸:');
                console.log('Math íŒ¨ë„ ìì‹ ìš”ì†Œ ê°œìˆ˜:', mathPanel.children.length);
                console.log('Math íŒ¨ë„ ë‚´ìš©:', mathPanel.innerHTML);
                
                // RW íŒ¨ë„ ìƒíƒœ í™•ì¸
                console.log('ğŸ” RW íŒ¨ë„ ìƒíƒœ í™•ì¸:');
                console.log('RW íŒ¨ë„ ìì‹ ìš”ì†Œ ê°œìˆ˜:', rwPanel.children.length);
                
                // ëª¨ë“  ë¬¸ì œ ë¡œë“œ í›„ MathJax ì¬ë Œë”ë§
                setTimeout(() => {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        console.log('ğŸ” ì „ì²´ í˜ì´ì§€ MathJax ì¬ë Œë”ë§ ì‹œì‘');
                        
                        // ì „ì²´ í˜ì´ì§€ì—ì„œ LaTeX êµ¬ë¬¸ì„ ê°•ì œë¡œ ë³µì›
                        const allMathElements = document.querySelectorAll('p');
                        allMathElements.forEach(p => {
                            let html = p.innerHTML;
                            // HTML ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ LaTeX êµ¬ë¬¸ìœ¼ë¡œ ë³µì›
                            html = html.replace(/&#92;&#91;/g, '\\[');
                            html = html.replace(/&#92;&#93;/g, '\\]');
                            html = html.replace(/&#92;&#40;/g, '\\(');
                            html = html.replace(/&#92;&#41;/g, '\\)');
                            html = html.replace(/&#92;cdot/g, '\\cdot');
                            html = html.replace(/&#92;tfrac/g, '\\tfrac');
                            html = html.replace(/&#92;frac/g, '\\frac');
                            html = html.replace(/&#92;sqrt/g, '\\sqrt');
                            html = html.replace(/&#92;sum/g, '\\sum');
                            html = html.replace(/&#92;int/g, '\\int');
                            
                            if (html !== p.innerHTML) {
                                console.log('ğŸ” ì „ì²´ í˜ì´ì§€ LaTeX êµ¬ë¬¸ ë³µì›:', html.substring(0, 100));
                                p.innerHTML = html;
                            }
                        });
                        
                        window.MathJax.typesetPromise().then(() => {
                            console.log('âœ… ì „ì²´ í˜ì´ì§€ MathJax ë Œë”ë§ ì™„ë£Œ');
                        }).catch(error => {
                            console.error('âŒ ì „ì²´ í˜ì´ì§€ MathJax ë Œë”ë§ ì˜¤ë¥˜:', error);
                        });
                    }
                }, 800);
                
                // ì´ˆê¸° ìƒíƒœì—ì„œ ìˆ¨ê²¨ì§„ íŒ¨ë„ì˜ required ì†ì„± ì œê±°
                const hiddenInputs = document.querySelectorAll('.accordion-panel[style*="display: none"] input[required]');
                hiddenInputs.forEach(input => {
                  input.required = false;
                });
                
                // ì‹¤ì‹œê°„ ê²€ì¦ ì„¤ì •
                setupRealTimeValidation();
            }
        });


    });

    // í¼ ì œì¶œ ì‹œ ê²€ì¦ ë° ì œì¶œ ì²˜ë¦¬
    document.getElementById('quizForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const validationResult = validateAllFields();
        
        if (!validationResult.isValid) {
            // ëˆ„ë½ëœ í•­ëª©ì´ ìˆìœ¼ë©´ ë©”ì‹œì§€ ì°½ í‘œì‹œ
            showValidationMessage(validationResult.missingItems, validationResult.subjectResults);
            return;
        }
        
        // ëª¨ë“  í•„ìˆ˜ ìš”ì†Œê°€ ì™„ë£Œë˜ë©´ ë©”ì‹œì§€ ì°½ ì—†ì´ ë°”ë¡œ í¼ ì œì¶œ
        this.submit();
    });
    
    // ëª¨ë“  í•„ìˆ˜ í•„ë“œ ê²€ì¦ í•¨ìˆ˜
    function validateAllFields() {
        const form = document.getElementById('quizForm');
        const missingItems = [];
        
        // 1. ì´ë¦„ ì²´í¬
        const studentName = form.querySelector('#studentName');
        if (!studentName.value.trim()) {
            missingItems.push('Student Name');
        }
        
        // 2. Grade ì²´í¬
        const studentGrade = form.querySelector('#studentGrade');
        if (!studentGrade.value) {
            missingItems.push('Grade');
        }
        
        // 3. ê³¼ëª©ë³„ë¡œ ë‹µì•ˆê³¼ í™•ì‹ ë„ ì²´í¬
        const allInputs = Array.from(form.querySelectorAll('input[type="radio"], input[type="text"]'));
        const questionNames = new Set();
        const confidenceNames = new Set();
        
        allInputs.forEach(input => {
            if (input.name.startsWith('q')) questionNames.add(input.name);
            if (input.name.startsWith('c')) confidenceNames.add(input.name);
        });
        
        // ê³¼ëª©ë³„ë¡œ ë¶„ë¥˜
        const rwMissingAnswers = [];
        const rwMissingConfidence = [];
        const mathMissingAnswers = [];
        const mathMissingConfidence = [];
        
        // ë‹µì•ˆ ì²´í¬ (ê³¼ëª©ë³„ë¡œ ë¶„ë¥˜)
        questionNames.forEach(name => {
            const group = form.querySelectorAll(`input[name='${name}']`);
            const isChecked = Array.from(group).some(input => input.checked || (input.type === 'text' && input.value.trim() !== ''));
            if (!isChecked) {
                // ê³¼ëª© íŒë³„ (RW ë˜ëŠ” Math)
                if (name.includes('RW')) {
                    const questionNum = name.replace('qRW', '');
                    rwMissingAnswers.push(questionNum);
                } else if (name.includes('Math')) {
                    const questionNum = name.replace('qMath', '');
                    mathMissingAnswers.push(questionNum);
                }
            }
        });
        
        // í™•ì‹ ë„ ì²´í¬ (ê³¼ëª©ë³„ë¡œ ë¶„ë¥˜)
        confidenceNames.forEach(name => {
            const group = form.querySelectorAll(`input[name='${name}']`);
            const isChecked = Array.from(group).some(input => input.checked);
            if (!isChecked) {
                // ê³¼ëª© íŒë³„ (RW ë˜ëŠ” Math)
                if (name.includes('RW')) {
                    const questionNum = name.replace('cRW', '');
                    rwMissingConfidence.push(questionNum);
                } else if (name.includes('Math')) {
                    const questionNum = name.replace('cMath', '');
                    mathMissingConfidence.push(questionNum);
                }
            }
        });
        
        // ê³¼ëª©ë³„ ê²°ê³¼ êµ¬ì„±
        const subjectResults = [];
        
        if (rwMissingAnswers.length > 0 || rwMissingConfidence.length > 0) {
            const rwItems = [];
            if (rwMissingAnswers.length > 0) {
                rwItems.push(`Answer: ${rwMissingAnswers.join(', ')}`);
            }
            if (rwMissingConfidence.length > 0) {
                rwItems.push(`Confidence Rating: ${rwMissingConfidence.join(', ')}`);
            }
            subjectResults.push(`RW:\n  â€¢ ${rwItems.join('\n  â€¢ ')}`);
        }
        
        if (mathMissingAnswers.length > 0 || mathMissingConfidence.length > 0) {
            const mathItems = [];
            if (mathMissingAnswers.length > 0) {
                mathItems.push(`Answer: ${mathMissingAnswers.join(', ')}`);
            }
            if (mathMissingConfidence.length > 0) {
                mathItems.push(`Confidence Rating: ${mathMissingConfidence.join(', ')}`);
            }
            subjectResults.push(`Math:\n  â€¢ ${mathItems.join('\n  â€¢ ')}`);
        }
        
        return {
            isValid: missingItems.length === 0 && subjectResults.length === 0,
            missingItems: missingItems,
            subjectResults: subjectResults
        };
    }
    
    // Submit ë²„íŠ¼ í´ë¦­ ì‹œ ê²€ì¦ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showValidationMessage(missingItems, subjectResults) {
        // ê¸°ì¡´ ë©”ì‹œì§€ ì°¾ê¸° (ì•„ì½”ë””ì–¸ íŒ¨ë„ ë‚´ë¶€ì—ì„œ ë¨¼ì € ì°¾ê¸°)
        let existingMessage = document.querySelector('.accordion-panel .validation-message') || document.querySelector('.validation-message');
        
        if (missingItems.length === 0 && subjectResults.length === 0) {
            // ëª¨ë“  í•­ëª©ì´ ì™„ë£Œë˜ë©´ ë©”ì‹œì§€ ìˆ¨ê¹€ (ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜)
            if (existingMessage) {
                existingMessage.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => existingMessage.remove(), 300);
            }
            return;
        }
        
        let message = 'Please complete the following required fields:\n\n';
        
        // ê¸°ë³¸ ì •ë³´ (ì´ë¦„, Grade)
        if (missingItems.length > 0) {
            message += 'Basic Information:\n';
            missingItems.forEach(item => {
                message += `  â€¢ ${item}\n`;
            });
            message += '\n';
        }
        
        // ê³¼ëª©ë³„ ì •ë³´
        if (subjectResults.length > 0) {
            subjectResults.forEach(subject => {
                message += `${subject}\n\n`;
            });
        }
        
        if (existingMessage) {
            // ê¸°ì¡´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ë‚´ìš©ë§Œ ì—…ë°ì´íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ ì—†ìŒ)
            existingMessage.textContent = message;
            // ìœ„ì¹˜ë„ ì¬ì¡°ì •
            updateMessagePosition(existingMessage);
        } else {
            // ìƒˆ ë©”ì‹œì§€ ìƒì„± (ì²« ë²ˆì§¸ í‘œì‹œ ì‹œì—ë§Œ ì• ë‹ˆë©”ì´ì…˜)
            const messageDiv = document.createElement('div');
            messageDiv.className = 'validation-message';
            messageDiv.style.cssText = `
                position: fixed;
                top: 120px;
                background: #e74c3c;
                color: white;
                padding: 14px 40px;
                border-radius: 12px;
                font-weight: 700;
                z-index: 10000;
                box-shadow: 0 4px 16px rgba(231, 76, 60, 0.3);
                width: 450px;
                white-space: pre-line;
                line-height: 1.5;
                font-size: 14px;
                animation: slideInRight 0.3s ease-out;
                letter-spacing: 1px;
                cursor: grab;
            `;
            
            messageDiv.textContent = message;
            
            // ë©”ì‹œì§€ ì°½ì„ bodyì— ì¶”ê°€í•˜ê³  ì•„ì½”ë””ì–¸ íŒ¨ë„ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³ ì •
            document.body.appendChild(messageDiv);
            
            // ìœ„ì¹˜ ì„¤ì •
            updateMessagePosition(messageDiv);
            
            // ë©”ì‹œì§€ ì°½ ë“œë˜ê·¸ ê¸°ëŠ¥ ì¶”ê°€
            makeDraggable(messageDiv);
        }
    }
    
    // ë©”ì‹œì§€ ì°½ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateMessagePosition(messageDiv) {
        const activePanel = document.querySelector('.accordion-panel[style*="display: block"]');
        if (activePanel) {
            const panelRect = activePanel.getBoundingClientRect();
            const containerRect = document.querySelector('.container').getBoundingClientRect();
            const maxLeft = window.innerWidth - messageDiv.offsetWidth - 20; // ì˜¤ë¥¸ìª½ ì—¬ë°± 20px
            
            // ë·°í¬íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ ê³„ì‚°
            let leftPosition = panelRect.right + 10;
            
            // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì¡°ì •
            if (leftPosition > maxLeft) {
                leftPosition = maxLeft;
            }
            
            // ìµœì†Œ ì™¼ìª½ ì—¬ë°± ë³´ì¥
            if (leftPosition < 20) {
                leftPosition = 20;
            }
            
            messageDiv.style.left = leftPosition + 'px';
        }
    }
    
    // ì‹¤ì‹œê°„ ê²€ì¦ì„ ìœ„í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
    function setupRealTimeValidation() {
        const form = document.getElementById('quizForm');
        
        // ëª¨ë“  ì…ë ¥ ìš”ì†Œì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const allInputs = form.querySelectorAll('input[type="text"], input[type="radio"], select');
        
        allInputs.forEach(input => {
            input.addEventListener('change', function() {
                // ë©”ì‹œì§€ ì°½ì´ ì´ë¯¸ ë…¸ì¶œë˜ì–´ ìˆì„ ë•Œë§Œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
                const existingMessage = document.querySelector('.validation-message');
                if (existingMessage) {
                    // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ê°’ì´ ì—…ë°ì´íŠ¸ëœ í›„ ê²€ì¦ ì‹¤í–‰
                    setTimeout(() => {
                        const validationResult = validateAllFields();
                        if (validationResult.missingItems.length > 0 || validationResult.subjectResults.length > 0) {
                            showValidationMessage(validationResult.missingItems, validationResult.subjectResults);
                        } else {
                            // ëª¨ë“  í•­ëª©ì´ ì™„ë£Œë˜ë©´ ë©”ì‹œì§€ ìˆ¨ê¹€
                            const existingMessage = document.querySelector('.accordion-panel .validation-message') || document.querySelector('.validation-message');
                            if (existingMessage) {
                                existingMessage.remove();
                            }
                        }
                    }, 100);
                }
            });
        });
    }
    
    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ íƒ€ì´ë¨¸ì™€ ë©”ì‹œì§€ ì°½ ìœ„ì¹˜ ì¬ì¡°ì •
    window.addEventListener('resize', function() {
        const timerBox = document.getElementById('timerBox');
        const messageDiv = document.querySelector('.validation-message');
        
        if (timerBox && timerBox.style.display !== 'none') {
            const activePanel = document.querySelector('.accordion-panel[style*="display: block"]');
            if (activePanel) {
                const panelRect = activePanel.getBoundingClientRect();
                const maxLeft = window.innerWidth - timerBox.offsetWidth - 20;
                
                let leftPosition = panelRect.right + 10;
                if (leftPosition > maxLeft) {
                    leftPosition = maxLeft;
                }
                if (leftPosition < 20) {
                    leftPosition = 20;
                }
                
                timerBox.style.left = leftPosition + 'px';
            }
        }
        
        if (messageDiv) {
            updateMessagePosition(messageDiv);
        }
    });
    
    // ìŠ¤í¬ë¡¤ ì‹œì—ë„ ìœ„ì¹˜ ì¬ì¡°ì •
    window.addEventListener('scroll', function() {
        const timerBox = document.getElementById('timerBox');
        const messageDiv = document.querySelector('.validation-message');
        
        if (timerBox && timerBox.style.display !== 'none') {
            const activePanel = document.querySelector('.accordion-panel[style*="display: block"]');
            if (activePanel) {
                const panelRect = activePanel.getBoundingClientRect();
                const maxLeft = window.innerWidth - timerBox.offsetWidth - 20;
                
                let leftPosition = panelRect.right + 10;
                if (leftPosition > maxLeft) {
                    leftPosition = maxLeft;
                }
                if (leftPosition < 20) {
                    leftPosition = 20;
                }
                
                timerBox.style.left = leftPosition + 'px';
            }
        }
        
        if (messageDiv) {
            updateMessagePosition(messageDiv);
        }
    });
    
    // ì¤Œ ë ˆë²¨ ë³€ê²½ ê°ì§€ ë° ìœ„ì¹˜ ì¬ì¡°ì •
    let lastZoom = window.devicePixelRatio;
    const checkZoomAndUpdate = () => {
        if (Math.abs(window.devicePixelRatio - lastZoom) > 0.1) {
            lastZoom = window.devicePixelRatio;
            setTimeout(() => {
                const timerBox = document.getElementById('timerBox');
                const messageDiv = document.querySelector('.validation-message');
                
                if (timerBox && timerBox.style.display !== 'none') {
                    const activePanel = document.querySelector('.accordion-panel[style*="display: block"]');
                    if (activePanel) {
                        const panelRect = activePanel.getBoundingClientRect();
                        const maxLeft = window.innerWidth - timerBox.offsetWidth - 20;
                        
                        let leftPosition = panelRect.right + 10;
                        if (leftPosition > maxLeft) {
                            leftPosition = maxLeft;
                        }
                        if (leftPosition < 20) {
                            leftPosition = 20;
                        }
                        
                        timerBox.style.left = leftPosition + 'px';
                    }
                }
                
                if (messageDiv) {
                    updateMessagePosition(messageDiv);
                }
            }, 100);
        }
    };
    
    // ì¤Œ ë³€ê²½ ê°ì§€ë¥¼ ìœ„í•œ ì£¼ê¸°ì  ì²´í¬
    setInterval(checkZoomAndUpdate, 500);
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥ í•¨ìˆ˜
    function makeDraggable(element) {
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        // ë“œë˜ê·¸ ì‹œì‘
        function dragStart(e) {
            if (e.type === "touchstart") {
                initialX = e.touches[0].clientX - xOffset;
                initialY = e.touches[0].clientY - yOffset;
            } else {
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;
            }
            
            if (e.target === element) {
                isDragging = true;
                element.style.cursor = 'grabbing';
                element.style.userSelect = 'none';
            }
        }
        
        // ë“œë˜ê·¸ ì¤‘
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                
                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                
                xOffset = currentX;
                yOffset = currentY;
                
                // ê²½ê³„ ì œí•œ ì œê±° - ììœ ë¡­ê²Œ ë“œë˜ê·¸ ê°€ëŠ¥
                
                setTranslate(currentX, currentY, element);
            }
        }
        
        // ë“œë˜ê·¸ ì¢…ë£Œ
        function dragEnd() {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
            element.style.cursor = 'grab';
            element.style.userSelect = 'auto';
        }
        
        // ìœ„ì¹˜ ì„¤ì •
        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
        }
        
        // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
        element.addEventListener("mousedown", dragStart);
        document.addEventListener("mousemove", drag);
        document.addEventListener("mouseup", dragEnd);
        
        // í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ ì§€ì›)
        element.addEventListener("touchstart", dragStart, { passive: false });
        document.addEventListener("touchmove", drag, { passive: false });
        document.addEventListener("touchend", dragEnd);
        
        // ë“œë˜ê·¸ ê°€ëŠ¥í•¨ì„ ë‚˜íƒ€ë‚´ëŠ” ìŠ¤íƒ€ì¼
        element.style.cursor = 'grab';
        element.style.userSelect = 'none';
    }
    

    

    
    // ìƒì„¸í•œ ì•Œë¦¼ ë©”ì‹œì§€ í•¨ìˆ˜
    function showDetailedNotification(message) {
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        const existingNotification = document.querySelector('.detailed-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // ìƒˆ ì•Œë¦¼ ìƒì„±
        const notification = document.createElement('div');
        notification.className = 'detailed-notification';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: #e74c3c;
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            animation: slideDown 0.3s ease-out;
            max-width: 500px;
            white-space: pre-line;
            line-height: 1.5;
            font-size: 14px;
        `;
        
        // ë©”ì‹œì§€ ë‚´ìš©
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.marginBottom = '15px';
        notification.appendChild(messageDiv);
        
        // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.gap = '10px';
        buttonContainer.style.justifyContent = 'flex-end';
        
        // ì ‘ì–´ë‘ê¸° ë²„íŠ¼
        const minimizeBtn = document.createElement('button');
        minimizeBtn.textContent = 'ì ‘ì–´ë‘ê¸°';
        minimizeBtn.style.cssText = `
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        `;
        minimizeBtn.onmouseover = () => minimizeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
        minimizeBtn.onmouseout = () => minimizeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        minimizeBtn.onclick = () => {
            notification.style.transform = 'translateX(-50%) translateY(-10px)';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        };
        
        // X ë²„íŠ¼
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s;
        `;
        closeBtn.onmouseover = () => closeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
        closeBtn.onmouseout = () => closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        closeBtn.onclick = () => {
            notification.style.animation = 'slideUp 0.3s ease-in';
            setTimeout(() => notification.remove(), 300);
        };
        
        buttonContainer.appendChild(minimizeBtn);
        buttonContainer.appendChild(closeBtn);
        notification.appendChild(buttonContainer);
        
        document.body.appendChild(notification);
    }
    </script>
    <style>
    .accordion-header {
      width: 100%;
      text-align: left;
      padding: 14px;
      font-size: 1.1em;
      background: #fff;
      border: 2px solid #071BE9;
      border-radius: 24px;
      margin-bottom: 12px;
      cursor: pointer;
      outline: none;
      transition: background 0.2s, border 0.2s;
    }
    .accordion-header:hover {
      background: #f3f4f6;
    }
    .accordion-panel {
      padding: 0 14px 14px 14px;
      border-bottom: 1px solid #e5e8f0;
      background: #fff;
    }
    .option-row {
      display: flex;
      align-items: center;
    }
    .option-alpha-label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      min-width: 32px;
      height: 32px;
      font-weight: 700;
      font-size: 1.08em;
      color: #071BE9;
      background: #fff;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      margin-right: 12px;
      user-select: none;
      box-sizing: border-box;
      transition: border 0.2s, background 0.2s;
    }
    .timer-box {
      position: fixed;
      top: 20px;
      z-index: 1000;
      background: #071BE9;
      color: #fff;
      font-size: 1.35em;
      font-weight: 700;
      padding: 14px 40px;
      border-radius: 32px;
      box-shadow: 0 4px 16px rgba(7,27,233,0.08);
      letter-spacing: 1px;
      transition: background 0.2s;
      opacity: 0.97;
      white-space: nowrap;
      cursor: grab;
    }
    
    .timer-box:active {
      cursor: grabbing;
    }
    
    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      .timer-box {
        font-size: 1.1em;
        padding: 12px 24px;
        top: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .timer-box {
        font-size: 1em;
        padding: 10px 20px;
        top: 10px;
      }
    }
    
    /* ë©”ì‹œì§€ ì°½ ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 768px) {
      .validation-message {
        width: 350px !important;
        font-size: 12px !important;
        padding: 12px 20px !important;
      }
    }
    
    @media (max-width: 480px) {
      .validation-message {
        width: 300px !important;
        font-size: 11px !important;
        padding: 10px 16px !important;
      }
    }
    
    /* ë“œë˜ê·¸ ê°€ëŠ¥í•œ ìš”ì†Œ ìŠ¤íƒ€ì¼ */
    .validation-message:active {
      cursor: grabbing !important;
    }
    .submit-btn:hover {
      background: #0515c7 !important;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes slideOutRight {
      from {
        opacity: 1;
        transform: translateX(0);
      }
      to {
        opacity: 0;
        transform: translateX(100%);
      }
    }
    </style>
</body>
</html>